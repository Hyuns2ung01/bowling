<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ğŸ³ ë³¼ë§ ê¸°ë¡ ë³´ê´€ì†Œ</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="container">
        <div class="header-top" style="justify-content: space-between; align-items: center;">
            <div style="display: flex; gap: 10px; align-items: center;">
                <a href="/admin.html" class="admin-link">ğŸ”</a>
                <a href="/" class="back-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                    ì…ë ¥í•˜ê¸°
                </a>
            </div>
            <h2 style="margin:0; border:none; font-size: 1.1rem;">ğŸ“… ì¼ë³„ ê¸°ë¡ ìˆœìœ„</h2>
        </div>

        <div class="section" style="padding: 15px;">
            <label>ì¡°íšŒ ë‚ ì§œ ì„ íƒ</label>
            <input type="date" id="viewDate" onchange="loadDailyData()">
        </div>

        <div class="section">
            <table class="history-table">
                <thead>
                    <tr>
                        <th>ìˆœìœ„</th>
                        <th>ì´ë¦„</th>
                        <th>1/2/3</th>
                        <th>í‰ê· </th>
                    </tr>
                </thead>
                <tbody id="dailyRankBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        document.getElementById('viewDate').value = new Date().toISOString().split('T')[0];

        let isAdmin = false;

        async function checkAdmin() {
            try {
                const res = await fetch('/api/admin/check');
                const data = await res.json();
                isAdmin = data.isAdmin;
                if (isAdmin) {
                    const header = document.querySelector('.header-top');
                    const logoutBtn = document.createElement('button');
                    logoutBtn.className = 'admin-logout';
                    logoutBtn.innerText = 'ë¡œê·¸ì•„ì›ƒ';
                    logoutBtn.onclick = logout;
                    header.appendChild(logoutBtn);
                }
            } catch (e) { console.error(e); }
        }

        async function logout() {
            await fetch('/api/admin/logout', { method: 'POST' });
            location.reload();
        }

        async function loadDailyData() {
            const date = document.getElementById('viewDate').value;
            try {
                const res = await fetch(`/api/ranking/daily?date=${date}`);
                const data = await res.json();

                const tbody = document.getElementById('dailyRankBody');
                tbody.innerHTML = '';

                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="padding:40px; color:#999; text-align:center;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }

                data.forEach((row, index) => {
                    let medalClass = '';
                    if (index === 0) medalClass = 'rank-gold';
                    else if (index === 1) medalClass = 'rank-silver';
                    else if (index === 2) medalClass = 'rank-bronze';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                    <td>
                        <span class="rank-badge ${medalClass}">${index + 1}</span>
                        ${isAdmin ? `
                        <div class="admin-actions">
                            <button class="edit-btn" onclick="openEditModal(${row.id}, '${row.player_name}', ${row.game_1}, ${row.game_2}, ${row.game_3})">ìˆ˜ì •</button>
                            <button class="del-btn" onclick="deleteRecord(${row.id})">ì‚­ì œ</button>
                        </div>` : ''}
                    </td>
                    <td><strong>${row.player_name}</strong></td>
                    <td style="color:#666; font-size:0.85rem;">${row.game_1}/${row.game_2}/${row.game_3}</td>
                    <td style="color:var(--primary); font-weight:800;">${parseFloat(row.daily_average).toFixed(2)}</td>
                `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì„œë²„ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
            }
        }

        async function deleteRecord(id) {
            if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const res = await fetch('/api/admin/delete-score', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            });
            if (res.ok) {
                alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadDailyData();
            } else {
                alert("ì‚­ì œ ì‹¤íŒ¨");
            }
        }

        function openEditModal(id, name, g1, g2, g3) {
            const newName = prompt("ì´ë¦„:", name);
            if (newName === null) return;
            const newG1 = prompt("1íšŒì°¨ ì ìˆ˜:", g1);
            if (newG1 === null) return;
            const newG2 = prompt("2íšŒì°¨ ì ìˆ˜:", g2);
            if (newG2 === null) return;
            const newG3 = prompt("3íšŒì°¨ ì ìˆ˜:", g3);
            if (newG3 === null) return;

            updateRecord(id, newName, newG1, newG2, newG3);
        }

        async function updateRecord(id, name, g1, g2, g3) {
            const res = await fetch('/api/admin/update-score', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, player_name: name, game_1: g1, game_2: g2, game_3: g3 })
            });
            if (res.ok) {
                alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadDailyData();
            } else {
                alert("ìˆ˜ì • ì‹¤íŒ¨");
            }
        }

        (async () => {
            await checkAdmin();
            await loadDailyData();
        })();
    </script>
</body>

</html>